"use strict";function isLeapYear(a){return(a%400===0||a%4===0&&a%100!==0)}function daysOfYear(a){return isLeapYear(a)?366:365}function daysOfMonth(a,b){const e=[31,28,31,30,31,30,31,31,30,31,30,31];if(0<=b&&11>=b){if(1===b&&isLeapYear(a)){return 29}return e[b]}return void 0}function weeksOfYear(f,e){e=e%7;const b=new Date(f,0,1);const a=(b.getDay()+7-e)%7;return Math.ceil((daysOfYear(f)+a)/7)}function createSvgElement(a){return document.createElementNS("http://www.w3.org/2000/svg",a)}function showTooltip(a){hideTooltip();const b=a.target;const f=document.createElement("div");f.setAttribute("id","svg-tooltip");f.innerHTML=b.getAttribute("data-date");f.classList.add("svg-tip","svg-tip-one-line");f.style.display="block";f.style.position="absolute";f.style.left=a.pageX-40+"px";f.style.top=a.pageY-40+"px";document.body.appendChild(f)}function hideTooltip(){const a=document.getElementById("svg-tooltip");a&&a.remove()}function onSvgRectClick(a){if(bgColor){a.target.setAttribute("fill",bgColor)}else{alert("请选择背景色！")}}function drawContributeMatrix(f,h,b){let svg=createSvgElement("svg");svg.setAttribute("width","673");svg.setAttribute("height","104");let root=createSvgElement("g");root.setAttribute("transform","translate(20, 20)");let monthPositions=new Array(12);for(let c=0;c<h;c++){let g=createSvgElement("g");let xPos=1+12*c;g.setAttribute("transform","translate("+xPos+", 0)");for(let r=0;r<f;r++){let rect=createSvgElement("rect");if(b){let date=b[c][r];if(date){if(date.getDate()===1){monthPositions[date.getMonth()]=xPos+12}rect.setAttribute("data-date",date.format("yyyy-MM-dd"));rect.addEventListener("mousemove",function(j){showTooltip(j)});rect.addEventListener("mouseout",function(){hideTooltip()});rect.addEventListener("click",function(j){onSvgRectClick(j)})}else{continue}}rect.setAttribute("id","rect"+(c*f+r));rect.setAttribute("class","day");rect.setAttribute("width","10");rect.setAttribute("height","10");rect.setAttribute("x","12");rect.setAttribute("y",""+12*r);rect.setAttribute("fill","#ebedf0");g.appendChild(rect)}root.appendChild(g)}const a=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"];for(let i=0;i<a.length;i++){let text=createSvgElement("text");text.setAttribute("class","month");text.setAttribute("x",monthPositions[i]);text.setAttribute("y","-10");text.innerHTML=a[i];root.appendChild(text)}const e=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];for(let i=0;i<e.length;i++){if(i%2===0){continue}let text=createSvgElement("text");text.setAttribute("class","weekday");text.setAttribute("dx","-18");text.setAttribute("dy",7+12*i);text.innerHTML=e[i];root.appendChild(text)}svg.appendChild(root);return svg}Date.prototype.format=function(a){const b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(let k in b){if(new RegExp("("+k+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length===1)?(b[k]):(("00"+b[k]).substr((""+b[k]).length)))}}return a};function getDateMatrix(b,a,e,f){let matrix=new Array(f);for(let c=0;c<f;c++){matrix[c]=new Array(7)}let date=new Date(b,0,1);let index=(date.getDay()+7-a)%7;for(let m=0;m<12;m++){let days=daysOfMonth(b,m);for(let d=1;d<=days;d++){matrix[Math.floor(index/e)][index%e]=new Date(b,m,d);index++}}return matrix}function getLegendElement(){return document.getElementById("js-legend")}function setBackgroundColor(b){bgColor=colors[b];const e=getLegendElement();if(e){const a=e.getElementsByTagName("li");for(let i=0;i<a.length;i++){const f=a[i].classList;if(i===b){f.remove("normal");f.add("selected")}else{f.remove("selected");f.add("normal")}}}}function addLegend(){const a=getLegendElement();if(a){for(let i=0;i<colors.length;i++){let li=document.createElement("li");li.style.backgroundColor=colors[i];li.classList.add("normal");li.addEventListener("click",function(){setBackgroundColor(i)});a.appendChild(li)}}}function uuid(){return([10000000]+-1000+-4000+-8000+-100000000000).replace(/[018]/g,function(a){return(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)})}function exportSchedule(){const a=document.getElementsByClassName("day");if(a){let exportFilename=document.getElementById("export-filename").value||"contribution.ics";if(!exportFilename.endsWith(".ics")){exportFilename=exportFilename.concat(".ics")}let ical=new ICAL.Component(["vcalendar",[],[]]);for(let i=0;i<a.length;i++){let date=a[i].getAttribute("data-date");let count=colors.indexOf(a[i].getAttribute("fill"));if(count>0){let vevent=new ICAL.Component("vevent");let event=new ICAL.Event(vevent);event.summary="要努力向 GitHub 提交 "+(count>=4?"4 次及以上哦！":count+" 次哦！");event.location="GitHub";event.description="由 "+window.location.origin+window.location.pathname+" 提供定制服务";event.uid=uuid().toLocaleUpperCase();event.startDate=ICAL.Time.fromDateTimeString(date+"T09:00:00");event.endDate=ICAL.Time.fromDateTimeString(date+"T10:00:00");let valarm=new ICAL.Component("valarm");valarm.addPropertyWithValue("action","DISPLAY");valarm.addPropertyWithValue("trigger",ICAL.Duration.fromSeconds(-300));valarm.addPropertyWithValue("description","Reminder");vevent.addSubcomponent(valarm);ical.addSubcomponent(vevent)}}if(ical.getAllSubcomponents().length>0){let contributionData=ical.toString();let blob=new Blob([contributionData],{type:"text/plain;charset=utf-8"});saveAs(blob,exportFilename)}else{alert("无数据！")}}}function importData(a){let selectedFile=a.target.files[0];if(selectedFile){document.getElementById("import-filename").innerHTML=selectedFile.name;let reader=new FileReader();reader.onload=function(){let ical=ICAL.parse(reader.result);let contribution=new ICAL.Component(ical).getAllSubcomponents("vevent");if(contribution){let dateCountDic=[];for(let i=0;i<contribution.length;i++){let data=new ICAL.Event(contribution[i]);let date=new Date(data.startDate.year,data.startDate.month-1,data.startDate.day);let matches=/\d+/.exec(data.summary);if(matches){let count=parseInt(matches[0]);if(count<0){count=0}else{if(count>4){count=4}}dateCountDic[date.format("yyyy-MM-dd")]=count}}const b=document.getElementsByClassName("day");if(b){for(let i=0;i<b.length;i++){let date=b[i].getAttribute("data-date");if(dateCountDic[date]){b[i].setAttribute("fill",colors[dateCountDic[date]])}}}}};reader.readAsText(selectedFile,"utf-8")}}function importSchedule(){document.getElementById("files").click()}function main(){addLegend();const f=new Date().getFullYear();const e=weeksOfYear(f,0);const h=getDateMatrix(f,0,7,e);const b=drawContributeMatrix(7,e,h);const a=document.getElementById("contribution");a.appendChild(b)}const colors=["#ebedf0","#c6e48b","#7bc96f","#239a3b","#196127"];let bgColor=void 0;main();